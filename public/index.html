<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Meta Pixel Code -->
    <script async="" src="../api/facebook-conversion.js"></script>
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '2137016300150066');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=2137016300150066&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé∞ Acceso VIP Exclusivo</title>
  <meta name="description" content="Super bono exclusivo para nuevos usuarios. ¬°Solic√≠talo ahora por WhatsApp!" />
  <meta property="og:title" content="Acceso VIP - Bono Especial" />
  <meta property="og:image" content="bonus.png" />
  <link rel="stylesheet" href="/style.css" />
  <link rel="icon" href="/favicon.ico" />
</head>
<body>
  <!-- Banner de oferta por tiempo limitado -->
  <div class="offer-banner">
    ¬°OFERTA POR TIEMPO LIMITADO!
  </div>

  <div class="container">
    <div class="logo">
      <img src="/logo.png" alt="Casino VIP" onerror="this.style.display='none'" />
    </div>
    
    <h1>ACCESO VIP EXCLUSIVO</h1>
    
    <div class="bonus">
      ¬°SUPER BONO EN TU PRIMER DEP√ìSITO!
    </div>
    
    <div class="highlight">
      RETIROS TODO EL D√çA
    </div>
    
    <p class="cta">Escribinos apretando el bot√≥n de abajo</p>
    
    <a id="whatsapp-btn" href="https://wa.me/5491125469875?text=Hola!%20quiero%20un%20usuario" target="_blank">
      <img src="/whatsapp-icon.png" alt="WhatsApp" class="icon" />
      OBTENER MI BONO AHORA
    </a>
  </div>

  <script>
    function getCookie(name) {
      const v = `; ${document.cookie}`;
      const parts = v.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    // Esperar a que el pixel se inicialice completamente
    function waitForFbq(callback) {
      if (typeof fbq !== 'undefined') {
        callback();
      } else {
        setTimeout(() => waitForFbq(callback), 100);
      }
    }

    function sendMetaEvent() {
      console.log('Iniciando env√≠o de evento...');
      
      const eventId = 'ev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      // Enviar evento via pixel browser
      waitForFbq(() => {
        fbq('track', 'Lead', { 
          value: 1.0, 
          currency: 'USD',
          content_name: 'VIP Casino Signup'
        }, { 
          eventID: eventId 
        });
        console.log('Evento enviado via pixel browser con ID:', eventId);
      });

      // Obtener cookies de Facebook
      const fbp = getCookie('_fbp');
      const fbc = getCookie('_fbc');
      
      console.log('Cookies encontradas:', { fbp, fbc });

      // Si no hay cookies, esperar un poco m√°s
      if (!fbp && !fbc) {
        console.warn('No se encontraron cookies de Facebook. Reintentando en 2 segundos...');
        setTimeout(() => {
          const retryFbp = getCookie('_fbp');
          const retryFbc = getCookie('_fbc');
          console.log('Cookies en segundo intento:', { fbp: retryFbp, fbc: retryFbc });
          sendServerSideEvent(eventId, retryFbp, retryFbc);
        }, 2000);
        return;
      }

      sendServerSideEvent(eventId, fbp, fbc);
    }

    function sendServerSideEvent(eventId, fbp, fbc) {
      const body = {
        event_name: 'Lead',
        event_id: eventId,
        fbp: fbp || '',
        fbc: fbc || '',
        user_agent: navigator.userAgent,
        event_time: Math.floor(Date.now() / 1000),
        event_source_url: window.location.href,
        currency: 'USD',
        value: 1.0
      };

      console.log('Enviando al servidor:', body);

      fetch('/api/facebook-conversion', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache'
        },
        body: JSON.stringify(body)
      })
        .then(res => {
          console.log('Respuesta del servidor status:', res.status);
          return res.json();
        })
        .then(res => {
          console.log('Evento enviado exitosamente:', res);
          if (res.error) {
            console.error('Error en respuesta:', res.error);
          }
        })
        .catch(err => {
          console.error('Error al enviar evento:', err);
        });
    }

    document.getElementById('whatsapp-btn').addEventListener('click', function (e) {
      console.log('Click en bot√≥n WhatsApp detectado');
      sendMetaEvent();
    });

    // Debug: Verificar cookies peri√≥dicamente
    setInterval(() => {
      const fbp = getCookie('_fbp');
      const fbc = getCookie('_fbc');
      if (fbp || fbc) {
        console.log('Cookies actuales:', { fbp, fbc });
      }
    }, 5000);

    // Protecci√≥n anti-copia b√°sica
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.ctrlKey && ['c', 'v', 'u'].includes(e.key)) e.preventDefault();
    });

    // Generar part√≠culas doradas
    function createSparkle() {
      const sparkle = document.createElement('div');
      sparkle.className = 'sparkle';
      sparkle.style.left = Math.random() * 100 + '%';
      sparkle.style.animationDelay = Math.random() * 3 + 's';
      sparkle.style.animationDuration = (Math.random() * 3 + 4) + 's';
      document.body.appendChild(sparkle);
      
      setTimeout(() => {
        sparkle.remove();
      }, 8000);
    }

    // Crear part√≠culas cada 500ms
    setInterval(createSparkle, 500);
  </script>
</body>
</html>
